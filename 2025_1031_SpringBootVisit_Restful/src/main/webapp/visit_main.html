<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<!-- Bootstrap3.x ver -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

<!-- SweetAlert 사용  -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style type="text/css">
	#box{
		width:600px;
		margin:auto;
		margin-top:50px;
		font-size:25px;
	}
	
	#title{
		text-align:center;
		color:green;
		text-shadow:1px 1px 1px black;
	}
	#disp{
		margin-top:10px;
		height: 100px;
		/* border: 1px solid black;  */
	}
	.common{
		padding:5px;
		border:1px solid #dddddd;
		margin-bottom: 10px;
		box-shadow: 1px 1px 3px #aaaaaa;
	}
	.content{
	min-height: 60px;
	}
	textarea{
	resize: none;
	}
	
</style>

<!-- 스크립트 -->
<script type="text/javascript">

	//화면 배치가 완료되면 
	$().ready(function(){
		visit_list();
		
	});

	function visit_list(){
		$("#disp").html("여기에 방명록 목록 출력하기")
		$.ajax({
			url:"/rest/visits"
			,type:"get"	
			,dataType:"json"
			,success:function(d){
				console.log("성공");
				//console.log(d);
					let htmlText="";
				for(let visit of d){
					console.log(visit.name);
						htmlText=htmlText+
						`
							<div class="panel panel-primary">
								<div class="panel-heading"> <b>${visit.name}</b>님의 글: </div>		
								<div class="panel-body"> 
									<div class="common content">${visit.content}</div>
									<div class="common regoate">작성일:${visit.regdate}</div>
									<div class="common">
										<form class="form-inline">
										<input type="hidden" name="idx" value="${visit.idx}">
											비밀번호(${visit.pwd}): 
										<input class="form-control" type="password" name="c_pwd">
										<input class="btn btn-info" type="button" value="수정" onclick="visit_modify_confirm(this.form);">
										<input class="btn btn-danger" type="button" value="삭제" onclick="visit_delete_confirm(this.form);">
										</form>
									</div>
								</div>
							</div>
						`;
				}
				$("#disp").html(htmlText);
			}
		,error:function(e){
			console.log(e);
			console.log("시스템 오류발생");
		}
			
		});
	};//end visit_list()
	
	function visit_delete_confirm(f){
		let idx = f.idx.value;
		let c_pwd = f.c_pwd.value.trim();
		
		if(c_pwd==''){
			alert("삭제할 게시물의 비밀번호를 입력하세요");
			f.c_pwd.value="";
			f.c_pwd.focus();
			return;
		}
		//비밀번호 체크
		$.ajax({
			url:`/rest/check-pwd/${idx}/${c_pwd}`
			,type:"get"
			,dataType:"json"
			,success:function(d){
				if(d.result==false){
					alert("삭제 비밀번호가 틀립니다.");
					return;
				}
				
				
				
				
				/* if(confirm("정말 삭제하시겠습니까?")==false){
					return;
				}
				
				visit_delete(idx); */
				
		//==================================================================================//
		Swal.fire({
				  title: "정말 삭제 하시겠습니까?",
				  text: "선택한 게시물을 삭제합니다.",
//				  icon: "warning",
				  icon: "question",
				  showCancelButton: true,
				  confirmButtonColor: "#3085d6",
				  cancelButtonColor: "#d33",
				  confirmButtonText: "삭제",
				  cancelButtonText: "취소"
				}).then((result) => {
					//confirmButton이 눌리면....
				  if (result.isConfirmed) {
					  
				visit_delete(idx);
				  }
				});
		
		
		//==================================================================================//
			}
			,error:function(e){
				alert(e.responseText);
			}
		});
		
		
		
	}//end visit_delete_confirm(f)
	
	function visit_delete(idx){
		$.ajax({
			type:"delete"
			,url:`/rest/visit/${idx}`
			,dataType:"json"
			,success:function(d){
				if(d.result==true){
					alert(idx+"번 삭제 되었습니다.");
					visit_list();
				}else if(d.result==false){
					alert("삭제 실패되었습니다.")
				}
			}
			,error:function(e){
				alert(e.responseText);
			}
		});
	}//end
	
	function visit_insert_form(){
		let html=`
					<form>
						<div class="panel panel-primary">
							<div class="panel-heading"> <h5>글작성</h5> </div>		
							<div class="panel-body">
								<div>
									<label>작성자 :</label>
									<input class="form-control" name="name">
								</div> 
								<div>
									<label>내 용 :</label>
									<textarea class="form-control" rows="5" cols="" name="content" ></textarea>
								</div>
								<div>
									<label>비밀번호 :</label>
									<input class="form-control" name="pwd" type="password">		
								</div>
								<div style="text-align:center; margin-top: 15px;">
									<input type="button" class="btn btn-info" value="목록보기" onclick="visit_list();">			
									<input type="button" class="btn btn-primary" value="글등록" onclick="visit_insert(this.form)">			
								</div>
							</div>
						</div>
					</form>
		`;
		$("#disp").html(html);
	}//end
	
	function visit_insert(f){
		let name = f.name.value.trim();
		let content = f.content.value.trim();
		let pwd = f.pwd.value.trim();
		
		if(name==""){
			alert("이름을 입력하세요")
			f.name.value="";
			f.name.focus();
			return;
		}
		if(content==""){
			alert("내용을 입력하세요")
			f.content.value="";
			f.content.focus();
			return;
		}
		if(pwd==""){
			alert("비밀번호를 입력하세요")
			f.pwd.value="";
			f.pwd.focus();
			return;
		}
		
		let visit = {"name":name,"content":content,"pwd":pwd};
		let str_visit=JSON.stringify(visit);
		console.log(visit);
		console.log(JSON.stringify(visit));
		console.log(JSON.parse(str_visit));
		
		// JSON.stringify(json)		: json object ->string 바꿔줌
		// JSON.parse(string형식 JSON)	: string -> json object
		
		$.ajax({
			type:"post"
			,dataType:"json"
			,url:"/rest/visit"
			,data: JSON.stringify(visit)
			,contentType:"application/json" // 데이터 전송할때 타입
			,success:function(d){
				if(d.result==false){
					alert("등록 실패")
					return;
				}
				
				//목록보기
				visit_list();
				
			}
			,error:function(e){
				alert("등록 실패"+e.responseText);
			}
		});//ajax
	}//end
	
	function visit_modify_confirm(f){
		let idx = f.idx.value;
		let c_pwd = f.c_pwd.value.trim();
		
		if(c_pwd==''){
			alert("수정할 게시물의 비밀번호를 입력하세요");
			f.c_pwd.value="";
			f.c_pwd.focus();
			return;
		}
		//비밀번호 체크
		$.ajax({
			url:`/rest/check-pwd/${idx}/${c_pwd}`
			,type:"get"
			,dataType:"json"
			,success:function(d){
				if(d.result==false){
					alert("수정 비밀번호가 틀립니다.");
					return;
				}
				if(confirm("정말 수정하시겠습니까?")==false){
					return;
				}
				//수정폼
				visit_modify_form(idx);
			}
			,error:function(e){
				alert(e.responseText);
			}
		});
	}//end
	
	function visit_modify_form(idx){
		
		let visit=null;
		//수정할 원본데이터 가져오기
		$.ajax({
			async : false //비동기에서 => 동기로 바꿀때
			,url:`/rest/visit/${idx}`
			,type:"get"
			,dataType:"json"
			,success:function(d){
				visit=d;
			//console.log("d",visit);
			}
			,error:function(e){
				
			}
		});//ajax
		
		//console.log("result",visit);
		let html=`
			<form>
		<input type="hidden" name="idx" value="${visit.idx}">
				<div class="panel panel-primary">
					<div class="panel-heading"> <h5>글수정하기</h5> </div>		
					<div class="panel-body">
						<div>
							<label>작성자 :</label>
							<input class="form-control" name="name" value="${visit.name}">
						</div> 
						<div>
							<label>내 용 :</label>
							<textarea class="form-control" rows="5" cols="" name="content" >${visit.content.replaceAll("<br>","\n")}</textarea>
						</div>
						<div>
							<label>비밀번호 :</label>
							<input class="form-control" name="pwd" type="password" value="${visit.pwd}">		
						</div>
						<div style="text-align:center; margin-top: 15px;">
							<input type="button" class="btn btn-info" value="목록보기" onclick="visit_list();">			
							<input type="button" class="btn btn-primary" value="글수정" onclick="visit_modify(this.form)">			
						</div>
					</div>
				</div>
			</form>
`;
$("#disp").html(html);
	};//end
	
	function visit_modify(f){
		let name = f.name.value.trim();
		let content = f.content.value.trim();
		let pwd = f.pwd.value.trim();
		
		if(name==""){
			alert("이름을 입력하세요")
			f.name.value="";
			f.name.focus();
			return;
		}
		if(content==""){
			alert("내용을 입력하세요")
			f.content.value="";
			f.content.focus();
			return;
		}
		if(pwd==""){
			alert("비밀번호를 입력하세요")
			f.pwd.value="";
			f.pwd.focus();
			return;
		}
		
		if(confirm("정말 수정하시겠습니까?")==false)return;
		$.ajax({
			url:"/rest/visit"
			,type : "put"
			,data:JSON.stringify({"name":name,"idx":f.idx.value,"content":content,"pwd":pwd})
			,dataType:"json"
			,contentType:"application/json"
			,success:function(d){
				if(d.result==false){
					alert("수정 실패했습니다.");
					return;
				}
					visit_list();
					alert("수정되었습니다.");
			}
			,error:function(e){
				alert(e.responseText);
			}
		});//ajax
	}//end
	
</script>
</head>
<body>

	<div id="box">
	

	
	
		<h1 id="title"> ::: 방명록 :::</h1>
		<div style="text-align: right;">
			<input class="btn btn-primary" type="button" value="글쓰기" onclick="visit_insert_form()">
		</div>
		
		
		<!-- 방명록 내용 출력부분(리스트/입력폼/수정폼) -->
		<div id="disp"></div>
	
	</div>

</body>
</html>